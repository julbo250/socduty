<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Astreintes SOC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 1em;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #2a5298;
            border-bottom: 3px solid #2a5298;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2a5298;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3c72;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(42, 82, 152, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .astreinte-card {
            background: #f8f9fa;
            border-left: 4px solid #2a5298;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .astreinte-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .astreinte-card.active {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .astreinte-card.upcoming {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .astreinte-card.past {
            border-left-color: #6c757d;
            background: #e9ecef;
            opacity: 0.7;
        }

        .astreinte-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .astreinte-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
        }

        .astreinte-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-active {
            background: #28a745;
            color: white;
        }

        .status-upcoming {
            background: #ffc107;
            color: #333;
        }

        .status-past {
            background: #6c757d;
            color: white;
        }

        .astreinte-details {
            margin: 10px 0;
            color: #555;
        }

        .astreinte-details p {
            margin: 5px 0;
        }

        .astreinte-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .incident-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }

        .incident-item.resolved {
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .incident-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .incident-severity {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .severity-critical {
            background: #dc3545;
            color: white;
        }

        .severity-high {
            background: #fd7e14;
            color: white;
        }

        .severity-medium {
            background: #ffc107;
            color: #333;
        }

        .severity-low {
            background: #17a2b8;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .calendar-view {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .recuperation-card {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .recuperation-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        @media (max-width: 768px) {
            .astreinte-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .astreinte-actions {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Gestion des Astreintes SOC</h1>
            <p>Planifiez et suivez vos p√©riodes d'astreinte</p>
            <div id="autoBackupIndicator" style="display: none; margin-top: 10px; padding: 8px 15px; background: rgba(255,255,255,0.2); border-radius: 20px; display: inline-block; font-size: 0.9em;">
                <span style="color: #28a745; font-weight: 600;">‚óè</span> Sauvegarde automatique active
            </div>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="showExportMenu()" style="background: white; color: #2a5298; padding: 10px 20px;">
                    üì• Exporter les donn√©es
                </button>
                <button class="btn" onclick="document.getElementById('importFile').click()" style="background: white; color: #2a5298; padding: 10px 20px; margin-left: 10px;">
                    üì§ Importer les donn√©es
                </button>
                <button class="btn" onclick="showSettingsMenu()" style="background: white; color: #2a5298; padding: 10px 20px; margin-left: 10px;">
                    ‚öôÔ∏è Param√®tres
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
            <div id="exportMenu" style="display: none; margin-top: 15px; background: white; padding: 15px; border-radius: 8px; max-width: 300px; margin-left: auto; margin-right: auto;">
                <p style="color: #333; font-weight: 600; margin-bottom: 10px;">Choisissez le format :</p>
                <button class="btn btn-primary" onclick="exportData(); hideExportMenu();" style="width: 100%; margin-bottom: 8px;">
                    üìÑ JSON (sauvegarde compl√®te)
                </button>
                <button class="btn btn-success" onclick="exportToCSV(); hideExportMenu();" style="width: 100%; margin-bottom: 8px;">
                    üìä CSV (pour Excel)
                </button>
                <button class="btn" onclick="hideExportMenu()" style="background: #6c757d; color: white; width: 100%;">
                    Annuler
                </button>
            </div>
            <div id="settingsMenu" style="display: none; margin-top: 15px; background: white; padding: 20px; border-radius: 8px; max-width: 400px; margin-left: auto; margin-right: auto; color: #333;">
                <h3 style="margin-bottom: 15px; color: #2a5298;">‚öôÔ∏è Param√®tres</h3>
                
                <!-- Configuration URL ITSM -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2a5298;">
                    <h4 style="margin-top: 0; margin-bottom: 10px; color: #2a5298;">üîó Configuration ITSM</h4>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-weight: 600; margin-bottom: 5px; display: block;">URL de base pour les tickets GLPI</label>
                        <input type="text" id="itsmUrlInput" placeholder="https://tiksoc.insee.fr/front/ticket.form.php?id=" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Cette URL sera utilis√©e pour g√©n√©rer les liens cliquables vers les tickets GLPI.<br>
                            Le num√©ro du ticket sera ajout√© automatiquement √† la fin de cette URL.
                        </small>
                    </div>
                    <button class="btn btn-primary" onclick="saveItsmUrl()" style="width: 100%; margin-top: 5px;">
                        üíæ Enregistrer l'URL
                    </button>
                </div>
                
                <!-- Sauvegarde automatique -->
                <h4 style="margin-bottom: 10px; color: #2a5298;">üíæ Sauvegarde automatique</h4>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                        <input type="checkbox" id="autoBackupEnabled" onchange="toggleAutoBackup()" style="width: auto; margin-right: 10px; cursor: pointer;">
                        <span>Activer la sauvegarde automatique</span>
                    </label>
                </div>

                <div id="autoBackupOptions" style="display: none; margin-left: 25px; margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Fr√©quence de sauvegarde :</label>
                    <select id="backupFrequency" onchange="updateBackupFrequency()" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                        <option value="daily">Quotidienne</option>
                        <option value="weekly" selected>Hebdomadaire</option>
                        <option value="monthly">Mensuelle</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 5px;">La sauvegarde se fera automatiquement en arri√®re-plan</small>
                </div>

                <div id="lastBackupInfo" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9em;">
                    <strong>Derni√®re sauvegarde :</strong> <span id="lastBackupDate">Aucune</span>
                </div>

                <button class="btn btn-success" onclick="manualBackup()" style="width: 100%; margin-bottom: 8px;">
                    üíæ Sauvegarder maintenant
                </button>
                <button class="btn" onclick="restoreFromAutoBackup()" style="background: #17a2b8; color: white; width: 100%; margin-bottom: 20px;">
                    üîÑ Restaurer la sauvegarde auto
                </button>
                
                <!-- Notifications -->
                <div style="border-top: 1px solid #e0e0e0; padding-top: 20px; margin-top: 10px;">
                    <h4 style="margin-bottom: 10px; color: #2a5298;">üîî Alertes de r√©cup√©ration</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                            <input type="checkbox" id="notificationsEnabled" onchange="toggleNotifications()" style="width: auto; margin-right: 10px; cursor: pointer;">
                            <span>Activer les alertes</span>
                        </label>
                        <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
                            Vous serez alert√© si une date limite approche
                        </small>
                    </div>

                    <div id="notificationOptions" style="display: none; margin-left: 25px; margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">D√©lai d'alerte :</label>
                        <select id="notificationDelay" onchange="updateNotificationDelay()" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                            <option value="30" selected>1 mois avant (30 jours)</option>
                            <option value="60">2 mois avant (60 jours)</option>
                            <option value="90">3 mois avant (90 jours)</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="hideSettingsMenu()" style="background: #6c757d; color: white; width: 100%; margin-top: 15px;">
                    Fermer
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Tableau de bord</button>
            <button class="tab" onclick="switchTab('astreintes')">üìÖ Mes Astreintes</button>
            <button class="tab" onclick="switchTab('recuperation')">üèñÔ∏è R√©cup√©ration</button>
            <button class="tab" onclick="switchTab('incidents')">üö® Incidents</button>
            <button class="tab" onclick="switchTab('nouvelle')">‚ûï Nouvelle Astreinte</button>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 style="margin-bottom: 20px;">Tableau de bord</h2>
                <div class="stats-grid" id="statsGrid"></div>
                <div id="currentAstreinte"></div>
            </div>

            <!-- Astreintes Tab -->
            <div id="astreintes" class="tab-content">
                <h2 style="margin-bottom: 20px;">Liste des Astreintes</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="exportAstreintesToCSV()">üì• Exporter les astreintes (CSV)</button>
                </div>
                <div id="astreintesList"></div>
            </div>

            <!-- R√©cup√©ration Tab -->
            <div id="recuperation" class="tab-content">
                <h2 style="margin-bottom: 20px;">Gestion des Jours de R√©cup√©ration</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 2.5em; font-weight: 700;" id="totalRecupDisplay">0</div>
                            <div style="opacity: 0.9;">Total acquis</div>
                        </div>
                        <div>
                            <div style="font-size: 2.5em; font-weight: 700; color: #ffc107;" id="prisRecupDisplay">0</div>
                            <div style="opacity: 0.9;">Jours pris</div>
                        </div>
                        <div>
                            <div style="font-size: 2.5em; font-weight: 700; color: #28a745;" id="restantRecupDisplay">0</div>
                            <div style="opacity: 0.9;">Disponibles</div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="showRecuperationForm()">‚ûï D√©clarer des jours pris</button>
                    <button class="btn btn-primary" onclick="showRecuperationHeuresForm()" style="margin-left: 10px;">‚è±Ô∏è R√©cup√©rer des heures</button>
                    <button class="btn" onclick="exportRecuperationToCSV()" style="background: #17a2b8; color: white; margin-left: 10px;">üì• Exporter les jours</button>
                    <button class="btn" onclick="checkNotifications()" style="background: #ff9800; color: white; margin-left: 10px;" title="V√©rifier les dates limites proches">üîî V√©rifier alertes</button>
                </div>

                <div id="recuperationForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">D√©clarer des jours de r√©cup√©ration pris</h3>
                    <div class="form-group">
                        <label>Date de d√©but *</label>
                        <input type="date" id="recuperationDateDebut" required>
                    </div>
                    <div class="form-group">
                        <label>Date de fin *</label>
                        <input type="date" id="recuperationDateFin" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre de jours *</label>
                        <input type="number" id="recuperationJours" step="0.5" min="0.5" required placeholder="Ex: 1.5">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="recuperationNotes" placeholder="Raison de la prise de r√©cup√©ration..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addRecuperation()">Enregistrer</button>
                    <button class="btn" onclick="hideRecuperationForm()" style="background: #6c757d; color: white;">Annuler</button>
                </div>

                <div id="recuperationHeuresForm" style="display: none; background: #e7f3ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">R√©cup√©ration d'heures d'incidents</h3>
                    <div class="form-group">
                        <label>Date de r√©cup√©ration *</label>
                        <input type="date" id="recupHeuresDate" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre d'heures √† r√©cup√©rer *</label>
                        <input type="number" id="recupHeuresNombre" step="0.5" min="0.5" required placeholder="Ex: 2.5">
                        <small style="color: #666; display: block; margin-top: 5px;">Ces heures seront d√©duites du compteur "Heures sur incidents"</small>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="recupHeuresNotes" placeholder="Raison de la r√©cup√©ration des heures..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addRecuperationHeures()">R√©cup√©rer les heures</button>
                    <button class="btn" onclick="hideRecuperationHeuresForm()" style="background: #6c757d; color: white;">Annuler</button>
                </div>

                <div id="recuperationList"></div>
            </div>

            <!-- Incidents Tab -->
            <div id="incidents" class="tab-content">
                <h2 style="margin-bottom: 20px;">Gestion des Incidents</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="showIncidentForm()">‚ûï D√©clarer un incident</button>
                </div>
                <div id="incidentForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Nouveau Incident</h3>
                    
                    <div class="form-group">
                        <label>Nom de l'analyste *</label>
                        <input type="text" id="incidentAnalyste" placeholder="Ex: Jean Dupont" required>
                    </div>

                    <div class="form-group">
                        <label>Ticket GLPI (ID)</label>
                        <input type="text" id="incidentTicketGLPI" placeholder="Ex: 12345">
                        <small style="color: #666; display: block; margin-top: 5px;">Num√©ro du ticket GLPI associ√© √† cet incident</small>
                    </div>

                    <div class="form-group">
                        <label>Date de l'incident *</label>
                        <input type="date" id="incidentDate" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Heure de d√©but *</label>
                            <input type="time" id="incidentHeureDebut" onchange="calculateHeuresWithMajoration()" required>
                        </div>
                        <div class="form-group">
                            <label>Heure de fin</label>
                            <input type="time" id="incidentHeureFin" onchange="calculateHeuresWithMajoration()">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Titre de l'incident *</label>
                        <input type="text" id="incidentTitle" placeholder="Ex: Tentative d'intrusion d√©tect√©e" required>
                    </div>
                    
                    <div class="form-group">
                        <label>S√©v√©rit√© *</label>
                        <select id="incidentSeverity">
                            <option value="critical">Critique</option>
                            <option value="high">Haute</option>
                            <option value="medium">Moyenne</option>
                            <option value="low">Basse</option>
                            <option value="false-positive">Faux-positif</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Heures pass√©es sur l'incident</label>
                        <input type="text" id="incidentHeures" placeholder="Ex: 2h30" pattern="[0-9]+h[0-9]{2}">
                        <small style="color: #666; display: block; margin-top: 5px;">Calcul√© automatiquement : forfait 1h si < 1h, sinon dur√©e r√©elle + 25%. Format: XhYY (ex: 2h15). Modifiable manuellement.</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Description et d√©tails des op√©rations men√©es</label>
                        <textarea id="incidentDescription" placeholder="D√©crivez l'incident et les op√©rations effectu√©es..." rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Probl√®mes rencontr√©s / Retex</label>
                        <textarea id="incidentRetex" placeholder="Probl√®mes rencontr√©s, retour d'exp√©rience..." rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 10px;">Communication</label>
                        <select id="commSelect" multiple size="8" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="cadreAstreinte">Cadre d'astreinte</option>
                            <option value="dsi">DSI</option>
                            <option value="rssi">RSSI</option>
                            <option value="anssi">ANSSI</option>
                            <option value="shfds">SHFDS</option>
                            <option value="socRie">SOC RIE</option>
                            <option value="soc">SOC</option>
                            <option value="renater">RENATER</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">Maintenez Ctrl (ou Cmd sur Mac) pour s√©lectionner plusieurs options</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Astreinte associ√©e</label>
                        <select id="incidentAstreinte"></select>
                    </div>
                    
                    <button class="btn btn-success" onclick="addIncident()">Enregistrer</button>
                    <button class="btn" onclick="hideIncidentForm()" style="background: #6c757d; color: white;">Annuler</button>
                </div>
                <div id="incidentsList"></div>
            </div>

            <!-- Nouvelle Astreinte Tab -->
            <div id="nouvelle" class="tab-content">
                <h2 style="margin-bottom: 20px;">Planifier une Astreinte</h2>
                <form onsubmit="addAstreinte(event)">
                    <div class="form-group">
                        <label>Nom de l'astreinte *</label>
                        <input type="text" id="nom" required placeholder="Ex: Astreinte Semaine 6">
                    </div>
                    <div class="form-group">
                        <label>Date de d√©but *</label>
                        <input type="date" id="dateDebut" required onchange="calculateDateLimiteRecup()">
                    </div>
                    <div class="form-group">
                        <label>Date de fin *</label>
                        <input type="date" id="dateFin" required>
                    </div>
                    <div class="form-group">
                        <label>Type d'astreinte</label>
                        <select id="type">
                            <option value="normale">Normale (1,5 jours de r√©cup√©ration)</option>
                            <option value="weekend">Week-end (1 jour de r√©cup√©ration)</option>
                            <option value="nuit">Nuit (0,5 jour de r√©cup√©ration)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nombre de jours f√©ri√©s dans la semaine</label>
                        <select id="nbJoursFeries">
                            <option value="0">0 - Aucun jour f√©ri√©</option>
                            <option value="1">1 - Un jour f√©ri√© (+0,5 jour de r√©cup√©ration)</option>
                            <option value="2">2 - Deux jours f√©ri√©s (+1 jour de r√©cup√©ration)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="notes" placeholder="Informations compl√©mentaires..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Date limite de r√©cup√©ration</label>
                        <input type="date" id="dateLimiteRecup" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                        <small style="color: #666; display: block; margin-top: 5px;">Calcul√©e automatiquement : date de d√©but + 1 an</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Enregistrer l'astreinte</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Stockage des donn√©es
        let astreintes = JSON.parse(localStorage.getItem('astreintes')) || [];
        let incidents = JSON.parse(localStorage.getItem('incidents')) || [];
        let recuperationsPrises = JSON.parse(localStorage.getItem('recuperationsPrises')) || [];
        let heuresRecuperees = JSON.parse(localStorage.getItem('heuresRecuperees')) || [];
        
        // URL ITSM configurable
        let itsmBaseUrl = localStorage.getItem('itsmBaseUrl') || 'https://tiksoc.insee.fr/front/ticket.form.php?id=';
        
        // Param√®tres de sauvegarde automatique
        let autoBackupSettings = JSON.parse(localStorage.getItem('autoBackupSettings')) || {
            enabled: false,
            frequency: 'weekly',
            lastBackup: null
        };
        
        // Param√®tres de notification (simple)
        let notificationSettings = JSON.parse(localStorage.getItem('notificationSettings')) || {
            enabled: false,
            delayDays: 30
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            updateAstreintesList();
            updateIncidentsList();
            updateIncidentAstreinteSelect();
            updateRecuperationView();
            initAutoBackup();
            checkAutoBackup();
        });

        // Convertir les heures d√©cimales en format XhYY
        function formatHeuresMinutes(heuresDecimal) {
            if (!heuresDecimal || heuresDecimal === 0) return '0h00';
            const heures = Math.floor(heuresDecimal);
            const minutes = Math.round((heuresDecimal - heures) * 60);
            return `${heures}h${minutes.toString().padStart(2, '0')}`;
        }

        // Calculer la date limite de r√©cup√©ration (date de d√©but + 1 an)
        function calculateDateLimiteRecup() {
            const dateDebut = document.getElementById('dateDebut').value;
            if (!dateDebut) {
                document.getElementById('dateLimiteRecup').value = '';
                return;
            }
            
            const date = new Date(dateDebut);
            // Ajouter 1 an
            date.setFullYear(date.getFullYear() + 1);
            
            // Formater la date au format YYYY-MM-DD pour l'input date
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            document.getElementById('dateLimiteRecup').value = `${year}-${month}-${day}`;
        }

        // Calculer les heures avec majoration de 25%
        function calculateHeuresWithMajoration() {
            const heureDebut = document.getElementById('incidentHeureDebut').value;
            const heureFin = document.getElementById('incidentHeureFin').value;
            
            if (!heureDebut || !heureFin) return;
            
            const [heuresDebut, minutesDebut] = heureDebut.split(':').map(Number);
            const [heuresFin, minutesFin] = heureFin.split(':').map(Number);
            
            const debut = heuresDebut * 60 + minutesDebut;
            const fin = heuresFin * 60 + minutesFin;
            
            let dureeMinutes = fin - debut;
            if (dureeMinutes < 0) {
                dureeMinutes += 24 * 60; // Si on passe minuit
            }
            
            let minutesFinales;
            
            // Si moins d'1 heure : forfait 1h sans majoration
            if (dureeMinutes < 60) {
                minutesFinales = 60;
            } else {
                // Si 1 heure ou plus : majoration de 25%
                minutesFinales = Math.round(dureeMinutes * 1.25);
            }
            
            // Convertir en format heures:minutes
            const heures = Math.floor(minutesFinales / 60);
            const minutes = minutesFinales % 60;
            const formattedTime = `${heures}h${minutes.toString().padStart(2, '0')}`;
            
            // Stocker aussi en d√©cimal pour les calculs
            const heuresDecimal = (minutesFinales / 60).toFixed(2);
            
            document.getElementById('incidentHeures').value = formattedTime;
            document.getElementById('incidentHeures').setAttribute('data-decimal', heuresDecimal);
        }

        // Gestion des onglets
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'astreintes') updateAstreintesList();
            if (tabName === 'recuperation') updateRecuperationView();
            if (tabName === 'incidents') updateIncidentsList();
        }

        // Ajouter une astreinte
        function addAstreinte(event) {
            event.preventDefault();
            
            // R√©cup√©rer le nombre de jours f√©ri√©s depuis la liste d√©roulante
            const nbJoursFeries = parseInt(document.getElementById('nbJoursFeries').value);
            const dateLimiteRecup = document.getElementById('dateLimiteRecup').value;
            
            const astreinte = {
                id: Date.now(),
                nom: document.getElementById('nom').value,
                dateDebut: document.getElementById('dateDebut').value,
                dateFin: document.getElementById('dateFin').value,
                type: document.getElementById('type').value,
                nbJoursFeries: nbJoursFeries,
                notes: document.getElementById('notes').value,
                dateLimiteRecup: dateLimiteRecup,
                createdAt: new Date().toISOString()
            };

            astreintes.push(astreinte);
            localStorage.setItem('astreintes', JSON.stringify(astreintes));

            event.target.reset();
            document.getElementById('dateLimiteRecup').value = ''; // R√©initialiser aussi ce champ
            alert('‚úÖ Astreinte enregistr√©e avec succ√®s !');
            updateDashboard();
            updateAstreintesList();
            updateIncidentAstreinteSelect();
        }

        // D√©terminer le statut d'une astreinte
        function getAstreinteStatus(astreinte) {
            const now = new Date();
            const debut = new Date(astreinte.dateDebut);
            const fin = new Date(astreinte.dateFin);

            if (now >= debut && now <= fin) return 'active';
            if (now < debut) return 'upcoming';
            return 'past';
        }

        // Calculer les jours de r√©cup√©ration pour une astreinte
        function calculateRecuperation(astreinte) {
            // Base fixe selon le type d'astreinte
            let recuperation = 0;
            
            switch(astreinte.type) {
                case 'normale':
                    recuperation = 1.5;
                    break;
                case 'weekend':
                    recuperation = 1.0;
                    break;
                case 'nuit':
                    recuperation = 0.5;
                    break;
                default:
                    recuperation = 1.5; // Par d√©faut, comme normale
            }
            
            // Bonus jours f√©ri√©s : 0,5 jour par jour f√©ri√©
            // Gestion de la compatibilit√© avec l'ancien format (jourFerie boolean)
            let nbJoursFeries = 0;
            if (astreinte.nbJoursFeries !== undefined) {
                nbJoursFeries = astreinte.nbJoursFeries;
            } else if (astreinte.jourFerie === true) {
                nbJoursFeries = 1; // Ancienne version avec checkbox
            }
            
            recuperation += nbJoursFeries * 0.5;
            
            return Math.round(recuperation * 10) / 10; // Arrondi √† 1 d√©cimale
        }

        // Calculer le total des jours de r√©cup√©ration
        function calculateTotalRecuperation() {
            const now = new Date();
            return astreintes.reduce((total, astreinte) => {
                // Ne compter que les astreintes termin√©es (date de fin < date actuelle)
                const fin = new Date(astreinte.dateFin);
                if (fin < now) {
                    return total + calculateRecuperation(astreinte);
                }
                return total;
            }, 0).toFixed(1);
        }

        // Calculer le total des jours de r√©cup√©ration pris
        function calculateTotalRecuperationPrise() {
            return recuperationsPrises.reduce((total, recup) => {
                return total + parseFloat(recup.jours);
            }, 0).toFixed(1);
        }

        // Calculer les jours de r√©cup√©ration restants
        function calculateRecuperationRestante() {
            const total = parseFloat(calculateTotalRecuperation());
            const pris = parseFloat(calculateTotalRecuperationPrise());
            return (total - pris).toFixed(1);
        }

        // Formater une date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Mettre √† jour le tableau de bord
        function updateDashboard() {
            const now = new Date();
            const activeAstreinte = astreintes.find(a => {
                const debut = new Date(a.dateDebut);
                const fin = new Date(a.dateFin);
                return now >= debut && now <= fin;
            });

            const upcomingAstreintes = astreintes.filter(a => new Date(a.dateDebut) > now).length;
            
            // Compter uniquement les astreintes termin√©es (date de fin <= date actuelle)
            const astreintesTerminees = astreintes.filter(a => {
                const fin = new Date(a.dateFin);
                return fin < now;
            }).length;
            
            const totalIncidents = incidents.length;
            const unresolvedIncidents = incidents.filter(i => !i.resolved).length;
            
            // Calcul des heures sur incidents : total - heures r√©cup√©r√©es
            const totalHeuresIncidents = incidents.reduce((total, incident) => total + (incident.heures || 0), 0);
            const totalHeuresRecuperees = heuresRecuperees.reduce((total, recup) => total + (recup.heures || 0), 0);
            const heuresIncidentsRestantes = totalHeuresIncidents - totalHeuresRecuperees;
            const heuresFormatted = formatHeuresMinutes(heuresIncidentsRestantes);

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${astreintesTerminees}</div>
                    <div class="stat-label">Astreintes termin√©es</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-value">${upcomingAstreintes}</div>
                    <div class="stat-label">√Ä venir</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stat-value">${calculateRecuperationRestante()}</div>
                    <div class="stat-label">Jours disponibles</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stat-value">${totalIncidents}</div>
                    <div class="stat-label">Incidents totaux</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="stat-value">${unresolvedIncidents}</div>
                    <div class="stat-label">Incidents en cours</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff9a56 0%, #ff6a00 100%);">
                    <div class="stat-value">${heuresFormatted}</div>
                    <div class="stat-label">Heures sur incidents</div>
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHTML;

            let currentHTML = '<h3 style="margin: 30px 0 15px 0;">Astreinte en cours</h3>';
            if (activeAstreinte) {
                const astreinteIncidents = incidents.filter(i => i.astreinteId === activeAstreinte.id);
                const recuperation = calculateRecuperation(activeAstreinte);
                
                // D√©terminer le texte pour les jours f√©ri√©s
                let ferieText = '';
                const nbJoursFeries = activeAstreinte.nbJoursFeries || (activeAstreinte.jourFerie ? 1 : 0);
                if (nbJoursFeries === 1) {
                    ferieText = ' (inclut 1 jour f√©ri√©)';
                } else if (nbJoursFeries === 2) {
                    ferieText = ' (inclut 2 jours f√©ri√©s)';
                }
                
                currentHTML += `
                    <div class="astreinte-card active">
                        <div class="astreinte-header">
                            <div class="astreinte-title">${activeAstreinte.nom}</div>
                            <span class="astreinte-status status-active">üü¢ En cours</span>
                        </div>
                        <div class="astreinte-details">
                            <p><strong>üìÖ D√©but:</strong> ${formatDate(activeAstreinte.dateDebut)}</p>
                            <p><strong>üèÅ Fin:</strong> ${formatDate(activeAstreinte.dateFin)}</p>
                            <p><strong>üè∑Ô∏è Type:</strong> ${activeAstreinte.type}</p>
                            <p><strong>üéÅ R√©cup√©ration:</strong> ${recuperation} jour${recuperation > 1 ? 's' : ''}${ferieText}</p>
                            ${activeAstreinte.dateLimiteRecup ? `<p><strong>‚è∞ Date limite r√©cup:</strong> ${formatDate(activeAstreinte.dateLimiteRecup)}</p>` : ''}
                            <p><strong>üö® Incidents:</strong> ${astreinteIncidents.length} (${astreinteIncidents.filter(i => !i.resolved).length} en cours)</p>
                            ${activeAstreinte.notes ? `<p><strong>üìù Notes:</strong> ${activeAstreinte.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            } else {
                currentHTML += `
                    <div class="empty-state">
                        <p style="font-size: 1.2em;">Aucune astreinte en cours</p>
                    </div>
                `;
            }

            document.getElementById('currentAstreinte').innerHTML = currentHTML;
        }

        // Mettre √† jour la liste des astreintes
        function updateAstreintesList() {
            const sortedAstreintes = [...astreintes].sort((a, b) => 
                new Date(b.dateDebut) - new Date(a.dateDebut)
            );

            if (sortedAstreintes.length === 0) {
                document.getElementById('astreintesList').innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 1.2em;">Aucune astreinte planifi√©e</p>
                        <p>Cliquez sur "Nouvelle Astreinte" pour en cr√©er une</p>
                    </div>
                `;
                return;
            }

            const html = sortedAstreintes.map(astreinte => {
                const status = getAstreinteStatus(astreinte);
                const statusLabels = {
                    active: { text: 'üü¢ En cours', class: 'status-active' },
                    upcoming: { text: 'üü° √Ä venir', class: 'status-upcoming' },
                    past: { text: '‚ö´ Termin√©e', class: 'status-past' }
                };

                const astreinteIncidents = incidents.filter(i => i.astreinteId === astreinte.id);
                const recuperation = calculateRecuperation(astreinte);
                
                // D√©terminer le texte pour les jours f√©ri√©s
                let ferieText = '';
                const nbJoursFeries = astreinte.nbJoursFeries || (astreinte.jourFerie ? 1 : 0);
                if (nbJoursFeries === 1) {
                    ferieText = ' (inclut 1 jour f√©ri√©)';
                } else if (nbJoursFeries === 2) {
                    ferieText = ' (inclut 2 jours f√©ri√©s)';
                }

                return `
                    <div class="astreinte-card ${status}">
                        <div class="astreinte-header">
                            <div class="astreinte-title">${astreinte.nom}</div>
                            <span class="astreinte-status ${statusLabels[status].class}">${statusLabels[status].text}</span>
                        </div>
                        <div class="astreinte-details">
                            <p><strong>üìÖ D√©but:</strong> ${formatDate(astreinte.dateDebut)}</p>
                            <p><strong>üèÅ Fin:</strong> ${formatDate(astreinte.dateFin)}</p>
                            <p><strong>üè∑Ô∏è Type:</strong> ${astreinte.type}</p>
                            <p><strong>üéÅ R√©cup√©ration:</strong> ${recuperation} jour${recuperation > 1 ? 's' : ''}${ferieText}</p>
                            ${astreinte.dateLimiteRecup ? `<p><strong>‚è∞ Date limite r√©cup:</strong> ${formatDate(astreinte.dateLimiteRecup)}</p>` : ''}
                            <p><strong>üö® Incidents:</strong> ${astreinteIncidents.length}</p>
                            ${astreinte.notes ? `<p><strong>üìù Notes:</strong> ${astreinte.notes}</p>` : ''}
                        </div>
                        <div class="astreinte-actions">
                            <button class="btn btn-danger" onclick="deleteAstreinte(${astreinte.id})">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('astreintesList').innerHTML = html;
        }

        // Supprimer une astreinte
        function deleteAstreinte(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette astreinte ?')) {
                astreintes = astreintes.filter(a => a.id !== id);
                localStorage.setItem('astreintes', JSON.stringify(astreintes));
                updateDashboard();
                updateAstreintesList();
                updateIncidentAstreinteSelect();
            }
        }

        // Afficher le formulaire d'incident
        function showIncidentForm() {
            document.getElementById('incidentForm').style.display = 'block';
            updateIncidentAstreinteSelect();
        }

        // Masquer le formulaire d'incident
        function hideIncidentForm() {
            document.getElementById('incidentForm').style.display = 'none';
        }

        // Mettre √† jour le select des astreintes dans le formulaire d'incident
        function updateIncidentAstreinteSelect() {
            const select = document.getElementById('incidentAstreinte');
            const options = astreintes.map(a => 
                `<option value="${a.id}">${a.nom} - ${new Date(a.dateDebut).toLocaleDateString('fr-FR')}</option>`
            ).join('');
            select.innerHTML = '<option value="">Aucune astreinte associ√©e</option>' + options;
        }

        // Ajouter un incident
        function addIncident() {
            const analyste = document.getElementById('incidentAnalyste').value;
            const ticketGLPI = document.getElementById('incidentTicketGLPI').value;
            const date = document.getElementById('incidentDate').value;
            const heureDebut = document.getElementById('incidentHeureDebut').value;
            const heureFin = document.getElementById('incidentHeureFin').value;
            const title = document.getElementById('incidentTitle').value;
            const severity = document.getElementById('incidentSeverity').value;
            const description = document.getElementById('incidentDescription').value;
            const retex = document.getElementById('incidentRetex').value;
            const astreinteId = document.getElementById('incidentAstreinte').value;
            const heuresInput = document.getElementById('incidentHeures');
            const heuresValue = heuresInput.value;

            if (!analyste || !date || !heureDebut || !title) {
                alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires (*)');
                return;
            }

            // Convertir le format XhYY en d√©cimal pour le stockage
            let heuresDecimal = 0;
            if (heuresValue) {
                if (heuresValue.includes('h')) {
                    const parts = heuresValue.split('h');
                    const h = parseInt(parts[0]) || 0;
                    const m = parseInt(parts[1]) || 0;
                    heuresDecimal = h + (m / 60);
                } else {
                    heuresDecimal = parseFloat(heuresValue) || 0;
                }
            }

            // R√©cup√©ration des communications depuis la liste d√©roulante
            const commSelect = document.getElementById('commSelect');
            const selectedOptions = Array.from(commSelect.selectedOptions).map(opt => opt.value);
            
            const communications = {
                cadreAstreinte: selectedOptions.includes('cadreAstreinte'),
                dsi: selectedOptions.includes('dsi'),
                rssi: selectedOptions.includes('rssi'),
                anssi: selectedOptions.includes('anssi'),
                shfds: selectedOptions.includes('shfds'),
                socRie: selectedOptions.includes('socRie'),
                soc: selectedOptions.includes('soc'),
                renater: selectedOptions.includes('renater')
            };

            const incident = {
                id: Date.now(),
                analyste,
                ticketGLPI,
                date,
                heureDebut,
                heureFin,
                title,
                severity,
                description,
                retex,
                heures: heuresDecimal,
                heuresFormatted: heuresValue,
                communications,
                astreinteId: astreinteId ? parseInt(astreinteId) : null,
                resolved: false,
                createdAt: new Date().toISOString()
            };

            incidents.push(incident);
            localStorage.setItem('incidents', JSON.stringify(incidents));

            // R√©initialisation du formulaire
            document.getElementById('incidentAnalyste').value = '';
            document.getElementById('incidentTicketGLPI').value = '';
            document.getElementById('incidentDate').value = '';
            document.getElementById('incidentHeureDebut').value = '';
            document.getElementById('incidentHeureFin').value = '';
            document.getElementById('incidentTitle').value = '';
            document.getElementById('incidentDescription').value = '';
            document.getElementById('incidentRetex').value = '';
            document.getElementById('incidentHeures').value = '';
            commSelect.selectedIndex = -1; // D√©s√©lectionner toutes les options
            
            hideIncidentForm();
            updateIncidentsList();
            updateDashboard();
            alert('‚úÖ Incident enregistr√© avec succ√®s !');
        }

        // Mettre √† jour la liste des incidents
        function updateIncidentsList() {
            const sortedIncidents = [...incidents].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );

            if (sortedIncidents.length === 0) {
                document.getElementById('incidentsList').innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 1.2em;">Aucun incident enregistr√©</p>
                    </div>
                `;
                return;
            }

            const severityLabels = {
                critical: { text: 'Critique', class: 'severity-critical' },
                high: { text: 'Haute', class: 'severity-high' },
                medium: { text: 'Moyenne', class: 'severity-medium' },
                low: { text: 'Basse', class: 'severity-low' },
                'false-positive': { text: 'Faux-positif', class: 'severity-low' }
            };

            const html = sortedIncidents.map(incident => {
                const astreinte = astreintes.find(a => a.id === incident.astreinteId);
                
                // G√©n√©rer la liste des communications
                let commList = [];
                if (incident.communications) {
                    if (incident.communications.cadreAstreinte) commList.push('Cadre d\'astreinte');
                    if (incident.communications.dsi) commList.push('DSI');
                    if (incident.communications.rssi) commList.push('RSSI');
                    if (incident.communications.anssi) commList.push('ANSSI');
                    if (incident.communications.shfds) commList.push('SHFDS');
                    if (incident.communications.socRie) commList.push('SOC RIE');
                    if (incident.communications.soc) commList.push('SOC');
                    if (incident.communications.renater) commList.push('RENATER');
                }
                
                return `
                    <div class="incident-item ${incident.resolved ? 'resolved' : ''}">
                        <div class="incident-header">
                            <div>
                                <strong style="font-size: 1.1em;">${incident.title}</strong>
                                <span class="incident-severity ${severityLabels[incident.severity].class}" style="margin-left: 10px;">
                                    ${severityLabels[incident.severity].text}
                                </span>
                            </div>
                            <div>
                                ${incident.resolved ? 
                                    '<span style="color: #28a745; font-weight: 600;">‚úÖ R√©solu</span>' : 
                                    `<button class="btn btn-success" onclick="resolveIncident(${incident.id})" style="padding: 5px 15px;">‚úì R√©soudre</button>`
                                }
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 12px; border-radius: 6px; margin: 10px 0;">
                            <p style="margin: 5px 0;"><strong>üë§ Analyste:</strong> ${incident.analyste || 'Non renseign√©'}</p>
                            ${incident.ticketGLPI ? `<p style="margin: 5px 0;"><strong>üé´ Ticket GLPI:</strong> <a href="${itsmBaseUrl}${incident.ticketGLPI}" target="_blank" rel="noopener noreferrer" style="color: #2a5298; text-decoration: none; font-weight: 600;">#${incident.ticketGLPI} üîó</a></p>` : ''}
                            <p style="margin: 5px 0;"><strong>üìÖ Date incident:</strong> ${incident.date ? new Date(incident.date).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'Non renseign√©'}</p>
                            <p style="margin: 5px 0;"><strong>üïê Horaires:</strong> ${incident.heureDebut || '-'} ${incident.heureFin ? '‚Üí ' + incident.heureFin : ''}</p>
                            ${incident.heures > 0 ? `<p style="margin: 5px 0;"><strong>‚è±Ô∏è Temps pass√©:</strong> ${incident.heuresFormatted || formatHeuresMinutes(incident.heures)} (avec majoration 25%)</p>` : ''}
                        </div>
                        
                        ${incident.description ? `
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 10px 0;">
                                <strong style="display: block; margin-bottom: 5px;">üìù Description et op√©rations:</strong>
                                <p style="color: #666; margin: 0; white-space: pre-wrap;">${incident.description}</p>
                            </div>
                        ` : ''}
                        
                        ${incident.retex ? `
                            <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 10px 0;">
                                <strong style="display: block; margin-bottom: 5px;">üí° Retex / Probl√®mes:</strong>
                                <p style="color: #666; margin: 0; white-space: pre-wrap;">${incident.retex}</p>
                            </div>
                        ` : ''}
                        
                        ${commList.length > 0 ? `
                            <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                                <strong style="display: block; margin-bottom: 5px;">üì¢ Communications:</strong>
                                <p style="margin: 0; color: #666;">${commList.join(', ')}</p>
                            </div>
                        ` : ''}
                        
                        <p style="font-size: 0.9em; color: #888; margin-top: 10px;">
                            üìù Enregistr√© le ${formatDate(incident.createdAt)}
                            ${astreinte ? ` | üõ°Ô∏è ${astreinte.nom}` : ''}
                        </p>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-primary" onclick="exportIncidentToPDF(${incident.id})" style="padding: 5px 15px;">
                                üìÑ Exporter PDF
                            </button>
                            <button class="btn btn-danger" onclick="deleteIncident(${incident.id})" style="padding: 5px 15px;">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('incidentsList').innerHTML = html;
        }

        // R√©soudre un incident
        function resolveIncident(id) {
            incidents = incidents.map(i => 
                i.id === id ? {...i, resolved: true, resolvedAt: new Date().toISOString()} : i
            );
            localStorage.setItem('incidents', JSON.stringify(incidents));
            updateIncidentsList();
            updateDashboard();
        }

        // Supprimer un incident
        function deleteIncident(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet incident ?')) {
                incidents = incidents.filter(i => i.id !== id);
                localStorage.setItem('incidents', JSON.stringify(incidents));
                updateIncidentsList();
                updateDashboard();
            }
        }

        // Afficher le formulaire de r√©cup√©ration
        function showRecuperationForm() {
            document.getElementById('recuperationForm').style.display = 'block';
        }

        // Masquer le formulaire de r√©cup√©ration
        function hideRecuperationForm() {
            document.getElementById('recuperationForm').style.display = 'none';
        }

        // Ajouter une r√©cup√©ration prise
        function addRecuperation() {
            const dateDebut = document.getElementById('recuperationDateDebut').value;
            const dateFin = document.getElementById('recuperationDateFin').value;
            const jours = document.getElementById('recuperationJours').value;
            const notes = document.getElementById('recuperationNotes').value;

            if (!dateDebut || !dateFin || !jours) {
                alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires');
                return;
            }

            const joursFloat = parseFloat(jours);
            const disponibles = parseFloat(calculateRecuperationRestante());

            if (joursFloat > disponibles) {
                alert(`‚ö†Ô∏è Vous n'avez que ${disponibles} jour(s) de r√©cup√©ration disponible(s)`);
                return;
            }

            const recuperation = {
                id: Date.now(),
                dateDebut,
                dateFin,
                jours: joursFloat,
                notes,
                createdAt: new Date().toISOString()
            };

            recuperationsPrises.push(recuperation);
            localStorage.setItem('recuperationsPrises', JSON.stringify(recuperationsPrises));

            document.getElementById('recuperationDateDebut').value = '';
            document.getElementById('recuperationDateFin').value = '';
            document.getElementById('recuperationJours').value = '';
            document.getElementById('recuperationNotes').value = '';
            
            hideRecuperationForm();
            updateRecuperationView();
            updateDashboard();
            alert('‚úÖ R√©cup√©ration enregistr√©e avec succ√®s !');
        }

        // Mettre √† jour la vue de r√©cup√©ration
        function updateRecuperationView() {
            const total = calculateTotalRecuperation();
            const pris = calculateTotalRecuperationPrise();
            const restant = calculateRecuperationRestante();

            document.getElementById('totalRecupDisplay').textContent = total;
            document.getElementById('prisRecupDisplay').textContent = pris;
            document.getElementById('restantRecupDisplay').textContent = restant;

            const sortedRecuperations = [...recuperationsPrises].sort((a, b) => 
                new Date(b.dateDebut) - new Date(a.dateDebut)
            );

            const sortedHeuresRecup = [...heuresRecuperees].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            let html = '';

            // Afficher les heures r√©cup√©r√©es
            if (sortedHeuresRecup.length > 0) {
                html += '<h3 style="margin: 20px 0 15px 0;">Heures r√©cup√©r√©es</h3>';
                sortedHeuresRecup.forEach(recup => {
                    html += `
                        <div class="astreinte-card" style="border-left-color: #17a2b8; background: #d1ecf1;">
                            <div class="astreinte-header">
                                <div class="astreinte-title">${recup.heures} heure${recup.heures > 1 ? 's' : ''} r√©cup√©r√©e${recup.heures > 1 ? 's' : ''}</div>
                                <span class="astreinte-status" style="background: #17a2b8; color: white;">‚è±Ô∏è R√©cup√©r√©es</span>
                            </div>
                            <div class="astreinte-details">
                                <p><strong>üìÖ Date:</strong> ${new Date(recup.date).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                ${recup.notes ? `<p><strong>üìù Notes:</strong> ${recup.notes}</p>` : ''}
                                <p style="font-size: 0.9em; color: #888; margin-top: 10px;">Enregistr√© le ${new Date(recup.createdAt).toLocaleDateString('fr-FR')}</p>
                            </div>
                            <div class="astreinte-actions">
                                <button class="btn btn-danger" onclick="deleteRecuperationHeures(${recup.id})">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    `;
                });
            }

            // Afficher les jours de r√©cup√©ration pris
            if (sortedRecuperations.length > 0) {
                html += '<h3 style="margin: 20px 0 15px 0;">Jours de r√©cup√©ration pris</h3>';
                sortedRecuperations.forEach(recup => {
                    html += `
                        <div class="astreinte-card">
                            <div class="astreinte-header">
                                <div class="astreinte-title">${recup.jours} jour${recup.jours > 1 ? 's' : ''} de r√©cup√©ration</div>
                                <span class="astreinte-status" style="background: #ffc107; color: #333;">üèñÔ∏è Pris</span>
                            </div>
                            <div class="astreinte-details">
                                <p><strong>üìÖ Du:</strong> ${new Date(recup.dateDebut).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p><strong>üìÖ Au:</strong> ${new Date(recup.dateFin).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                ${recup.notes ? `<p><strong>üìù Notes:</strong> ${recup.notes}</p>` : ''}
                                <p style="font-size: 0.9em; color: #888; margin-top: 10px;">Enregistr√© le ${new Date(recup.createdAt).toLocaleDateString('fr-FR')}</p>
                            </div>
                            <div class="astreinte-actions">
                                <button class="btn btn-danger" onclick="deleteRecuperation(${recup.id})">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    `;
                });
            }

            if (sortedHeuresRecup.length === 0 && sortedRecuperations.length === 0) {
                html = `
                    <div class="empty-state">
                        <p style="font-size: 1.2em;">Aucune r√©cup√©ration enregistr√©e</p>
                    </div>
                `;
            }

            document.getElementById('recuperationList').innerHTML = html;
        }

        // Supprimer une r√©cup√©ration
        function deleteRecuperation(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette r√©cup√©ration ?')) {
                recuperationsPrises = recuperationsPrises.filter(r => r.id !== id);
                localStorage.setItem('recuperationsPrises', JSON.stringify(recuperationsPrises));
                updateRecuperationView();
                updateDashboard();
            }
        }

        // Afficher le formulaire de r√©cup√©ration d'heures
        function showRecuperationHeuresForm() {
            document.getElementById('recuperationHeuresForm').style.display = 'block';
            document.getElementById('recuperationForm').style.display = 'none';
        }

        // Masquer le formulaire de r√©cup√©ration d'heures
        function hideRecuperationHeuresForm() {
            document.getElementById('recuperationHeuresForm').style.display = 'none';
        }

        // Ajouter une r√©cup√©ration d'heures
        function addRecuperationHeures() {
            const date = document.getElementById('recupHeuresDate').value;
            const heures = document.getElementById('recupHeuresNombre').value;
            const notes = document.getElementById('recupHeuresNotes').value;

            if (!date || !heures) {
                alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires');
                return;
            }

            const heuresFloat = parseFloat(heures);
            
            // V√©rifier qu'on ne r√©cup√®re pas plus que le total disponible
            const totalHeuresIncidents = incidents.reduce((total, incident) => total + (incident.heures || 0), 0);
            const totalHeuresRecuperees = heuresRecuperees.reduce((total, recup) => total + (recup.heures || 0), 0);
            const heuresRestantes = totalHeuresIncidents - totalHeuresRecuperees;

            if (heuresFloat > heuresRestantes) {
                alert(`‚ö†Ô∏è Vous n'avez que ${heuresRestantes.toFixed(1)} heure(s) d'incidents disponibles`);
                return;
            }

            const recuperation = {
                id: Date.now(),
                date,
                heures: heuresFloat,
                notes,
                createdAt: new Date().toISOString()
            };

            heuresRecuperees.push(recuperation);
            localStorage.setItem('heuresRecuperees', JSON.stringify(heuresRecuperees));

            document.getElementById('recupHeuresDate').value = '';
            document.getElementById('recupHeuresNombre').value = '';
            document.getElementById('recupHeuresNotes').value = '';
            
            hideRecuperationHeuresForm();
            updateRecuperationView();
            updateDashboard();
            alert('‚úÖ Heures r√©cup√©r√©es avec succ√®s !');
        }

        // Supprimer une r√©cup√©ration d'heures
        function deleteRecuperationHeures(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette r√©cup√©ration d\'heures ?')) {
                heuresRecuperees = heuresRecuperees.filter(r => r.id !== id);
                localStorage.setItem('heuresRecuperees', JSON.stringify(heuresRecuperees));
                updateRecuperationView();
                updateDashboard();
            }
        }

        // Exporter les donn√©es
        function exportData() {
            const data = {
                astreintes: astreintes,
                incidents: incidents,
                recuperationsPrises: recuperationsPrises,
                heuresRecuperees: heuresRecuperees,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `astreintes-soc-export-${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('‚úÖ Donn√©es export√©es avec succ√®s !');
        }

        // Importer les donn√©es
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // V√©rification de la structure des donn√©es
                    if (!data.astreintes || !data.incidents || !data.recuperationsPrises) {
                        alert('‚ö†Ô∏è Format de fichier invalide');
                        return;
                    }

                    // Demander confirmation avant d'√©craser les donn√©es
                    const confirmMsg = `Cette action va remplacer toutes vos donn√©es actuelles.\n\n` +
                                      `Donn√©es actuelles :\n` +
                                      `- ${astreintes.length} astreintes\n` +
                                      `- ${incidents.length} incidents\n` +
                                      `- ${recuperationsPrises.length} r√©cup√©rations prises\n` +
                                      `- ${heuresRecuperees.length} heures r√©cup√©r√©es\n\n` +
                                      `Nouvelles donn√©es :\n` +
                                      `- ${data.astreintes.length} astreintes\n` +
                                      `- ${data.incidents.length} incidents\n` +
                                      `- ${data.recuperationsPrises.length} r√©cup√©rations prises\n` +
                                      `- ${data.heuresRecuperees ? data.heuresRecuperees.length : 0} heures r√©cup√©r√©es\n\n` +
                                      `Continuer ?`;

                    if (!confirm(confirmMsg)) {
                        event.target.value = ''; // Reset input
                        return;
                    }

                    // Import des donn√©es
                    astreintes = data.astreintes;
                    incidents = data.incidents;
                    recuperationsPrises = data.recuperationsPrises;
                    heuresRecuperees = data.heuresRecuperees || [];

                    // Sauvegarde dans localStorage
                    localStorage.setItem('astreintes', JSON.stringify(astreintes));
                    localStorage.setItem('incidents', JSON.stringify(incidents));
                    localStorage.setItem('recuperationsPrises', JSON.stringify(recuperationsPrises));
                    localStorage.setItem('heuresRecuperees', JSON.stringify(heuresRecuperees));

                    // Mise √† jour de l'interface
                    updateDashboard();
                    updateAstreintesList();
                    updateIncidentsList();
                    updateRecuperationView();
                    updateIncidentAstreinteSelect();

                    alert('‚úÖ Donn√©es import√©es avec succ√®s !');
                    event.target.value = ''; // Reset input

                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import : fichier JSON invalide');
                    console.error('Import error:', error);
                    event.target.value = ''; // Reset input
                }
            };

            reader.readAsText(file);
        }

        // Export CSV pour Excel
        function exportToCSV() {
            // Export des astreintes
            let csvAstreintes = 'Type,Nom,Date D√©but,Date Fin,Type Astreinte,Nb Jours F√©ri√©s,Jours R√©cup√©ration,Date Limite R√©cup,Notes\n';
            astreintes.forEach(a => {
                const recup = calculateRecuperation(a);
                const nbJoursFeries = a.nbJoursFeries || (a.jourFerie ? 1 : 0);
                const dateLimite = a.dateLimiteRecup || '';
                csvAstreintes += `Astreinte,"${a.nom}","${a.dateDebut}","${a.dateFin}","${a.type}","${nbJoursFeries}","${recup}","${dateLimite}","${(a.notes || '').replace(/"/g, '""')}"\n`;
            });

            // Export des incidents avec tous les nouveaux champs
            let csvIncidents = '\n\nType,Analyste,Ticket GLPI,Date Incident,Heure D√©but,Heure Fin,Titre,S√©v√©rit√©,Heures,Description,Retex,Communications,R√©solu,Astreinte,Date Enregistrement\n';
            incidents.forEach(i => {
                const astreinte = astreintes.find(a => a.id === i.astreinteId);
                let commList = [];
                if (i.communications) {
                    if (i.communications.cadreAstreinte) commList.push('Cadre Astreinte');
                    if (i.communications.dsi) commList.push('DSI');
                    if (i.communications.rssi) commList.push('RSSI');
                    if (i.communications.anssi) commList.push('ANSSI');
                    if (i.communications.shfds) commList.push('SHFDS');
                    if (i.communications.socRie) commList.push('SOC RIE');
                    if (i.communications.soc) commList.push('SOC');
                    if (i.communications.renater) commList.push('RENATER');
                }
                csvIncidents += `Incident,"${i.analyste || ''}","${i.ticketGLPI || ''}","${i.date || ''}","${i.heureDebut || ''}","${i.heureFin || ''}","${i.title}","${i.severity}","${i.heures || 0}","${(i.description || '').replace(/"/g, '""')}","${(i.retex || '').replace(/"/g, '""')}","${commList.join('; ')}","${i.resolved ? 'Oui' : 'Non'}","${astreinte ? astreinte.nom : '-'}","${i.createdAt}"\n`;
            });

            // Export des r√©cup√©rations
            let csvRecuperations = '\n\nType,Date D√©but,Date Fin,Jours,Notes\n';
            recuperationsPrises.forEach(r => {
                csvRecuperations += `R√©cup√©ration,"${r.dateDebut}","${r.dateFin}","${r.jours}","${(r.notes || '').replace(/"/g, '""')}"\n`;
            });

            const csvContent = csvAstreintes + csvIncidents + csvRecuperations;
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `astreintes-soc-export-${dateStr}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('‚úÖ Export CSV r√©ussi !');
        }

        // Export CSV des astreintes uniquement
        function exportAstreintesToCSV() {
            let csv = 'Nom,Date D√©but,Date Fin,Type Astreinte,Nb Jours F√©ri√©s,Jours R√©cup√©ration,Date Limite R√©cup,Notes\n';
            
            const sortedAstreintes = [...astreintes].sort((a, b) => 
                new Date(a.dateDebut) - new Date(b.dateDebut)
            );
            
            sortedAstreintes.forEach(a => {
                const recup = calculateRecuperation(a);
                const nbJoursFeries = a.nbJoursFeries || (a.jourFerie ? 1 : 0);
                const dateDebut = new Date(a.dateDebut).toLocaleDateString('fr-FR');
                const dateFin = new Date(a.dateFin).toLocaleDateString('fr-FR');
                const dateLimite = a.dateLimiteRecup ? new Date(a.dateLimiteRecup).toLocaleDateString('fr-FR') : '-';
                csv += `"${a.nom}","${dateDebut}","${dateFin}","${a.type}","${nbJoursFeries}","${recup}","${dateLimite}","${(a.notes || '').replace(/"/g, '""')}"\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `astreintes-${dateStr}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('‚úÖ Export des astreintes r√©ussi !');
        }

        // Export CSV des jours de r√©cup√©ration uniquement
        function exportRecuperationToCSV() {
            let csv = 'Date D√©but,Date Fin,Jours,Notes,Date Enregistrement\n';
            
            const sortedRecuperations = [...recuperationsPrises].sort((a, b) => 
                new Date(a.dateDebut) - new Date(b.dateDebut)
            );
            
            sortedRecuperations.forEach(r => {
                const dateDebut = new Date(r.dateDebut).toLocaleDateString('fr-FR');
                const dateFin = new Date(r.dateFin).toLocaleDateString('fr-FR');
                const dateEnreg = new Date(r.createdAt).toLocaleDateString('fr-FR');
                csv += `"${dateDebut}","${dateFin}","${r.jours}","${(r.notes || '').replace(/"/g, '""')}","${dateEnreg}"\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `jours-recuperation-${dateStr}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('‚úÖ Export des jours de r√©cup√©ration r√©ussi !');
        }

        // Afficher le menu d'export
        function showExportMenu() {
            document.getElementById('exportMenu').style.display = 'block';
            document.getElementById('settingsMenu').style.display = 'none';
        }

        // Masquer le menu d'export
        function hideExportMenu() {
            document.getElementById('exportMenu').style.display = 'none';
        }

        // Afficher le menu des param√®tres
        function showSettingsMenu() {
            document.getElementById('settingsMenu').style.display = 'block';
            document.getElementById('exportMenu').style.display = 'none';
            
            // Charger l'URL ITSM actuelle dans le champ
            document.getElementById('itsmUrlInput').value = itsmBaseUrl;
            
            // Charger l'√©tat des notifications
            document.getElementById('notificationsEnabled').checked = notificationSettings.enabled;
            document.getElementById('notificationDelay').value = notificationSettings.delayDays;
            document.getElementById('notificationOptions').style.display = notificationSettings.enabled ? 'block' : 'none';
            
            updateSettingsDisplay();
        }

        // Masquer le menu des param√®tres
        function hideSettingsMenu() {
            document.getElementById('settingsMenu').style.display = 'none';
        }

        // Sauvegarder l'URL ITSM
        function saveItsmUrl() {
            const urlInput = document.getElementById('itsmUrlInput').value.trim();
            
            if (!urlInput) {
                alert('‚ö†Ô∏è Veuillez saisir une URL');
                return;
            }
            
            // Validation basique de l'URL
            if (!urlInput.startsWith('http://') && !urlInput.startsWith('https://')) {
                alert('‚ö†Ô∏è L\'URL doit commencer par http:// ou https://');
                return;
            }
            
            itsmBaseUrl = urlInput;
            localStorage.setItem('itsmBaseUrl', itsmBaseUrl);
            alert('‚úÖ URL ITSM enregistr√©e avec succ√®s !');
        }

        // Activer/d√©sactiver les notifications (simple)
        function toggleNotifications() {
            notificationSettings.enabled = document.getElementById('notificationsEnabled').checked;
            
            if (notificationSettings.enabled) {
                // V√©rifier si le navigateur supporte les notifications
                if (!('Notification' in window)) {
                    alert('‚ö†Ô∏è Votre navigateur ne supporte pas les notifications.');
                    document.getElementById('notificationsEnabled').checked = false;
                    notificationSettings.enabled = false;
                    return;
                }
                
                // Demander la permission si n√©cessaire
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            document.getElementById('notificationOptions').style.display = 'block';
                            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
                        } else {
                            document.getElementById('notificationsEnabled').checked = false;
                            notificationSettings.enabled = false;
                            alert('‚ö†Ô∏è Permission refus√©e. Autorisez les notifications dans votre navigateur.');
                        }
                    });
                } else if (Notification.permission === 'granted') {
                    document.getElementById('notificationOptions').style.display = 'block';
                    localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
                } else {
                    document.getElementById('notificationsEnabled').checked = false;
                    notificationSettings.enabled = false;
                    alert('‚ö†Ô∏è Notifications bloqu√©es. Modifiez les param√®tres de votre navigateur.');
                }
            } else {
                document.getElementById('notificationOptions').style.display = 'none';
                localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
            }
        }

        // Mettre √† jour le d√©lai de notification
        function updateNotificationDelay() {
            notificationSettings.delayDays = parseInt(document.getElementById('notificationDelay').value);
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
        }

        // V√©rifier les dates limites (fonction simple)
        function checkNotifications() {
            // Ne rien faire si pas activ√© ou pas de permission
            if (!notificationSettings.enabled) return;
            if (!('Notification' in window)) return;
            if (Notification.permission !== 'granted') return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            astreintes.forEach(astreinte => {
                if (!astreinte.dateLimiteRecup) return;

                const dateLimite = new Date(astreinte.dateLimiteRecup);
                dateLimite.setHours(0, 0, 0, 0);
                
                // Calculer les jours restants
                const daysRemaining = Math.ceil((dateLimite - today) / (24 * 60 * 60 * 1000));
                
                // V√©rifier si on est dans le d√©lai d'alerte
                if (daysRemaining > 0 && daysRemaining <= notificationSettings.delayDays) {
                    const recuperation = calculateRecuperation(astreinte);
                    
                    new Notification('‚ö†Ô∏è Date limite proche !', {
                        body: `Astreinte "${astreinte.nom}"\n${recuperation} jour(s) √† utiliser avant le ${dateLimite.toLocaleDateString('fr-FR')}\n(${daysRemaining} jour(s) restant(s))`,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üîî</text></svg>',
                        requireInteraction: false
                    });
                }
            });
        }

        // Initialiser l'affichage des param√®tres
        function initAutoBackup() {
            document.getElementById('autoBackupEnabled').checked = autoBackupSettings.enabled;
            document.getElementById('backupFrequency').value = autoBackupSettings.frequency;
            document.getElementById('autoBackupOptions').style.display = autoBackupSettings.enabled ? 'block' : 'none';
            updateLastBackupDisplay();
            updateAutoBackupIndicator();
        }

        // Mettre √† jour l'indicateur de sauvegarde automatique
        function updateAutoBackupIndicator() {
            const indicator = document.getElementById('autoBackupIndicator');
            if (autoBackupSettings.enabled) {
                indicator.style.display = 'inline-block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Mettre √† jour l'affichage des param√®tres
        function updateSettingsDisplay() {
            document.getElementById('autoBackupEnabled').checked = autoBackupSettings.enabled;
            document.getElementById('backupFrequency').value = autoBackupSettings.frequency;
            document.getElementById('autoBackupOptions').style.display = autoBackupSettings.enabled ? 'block' : 'none';
            updateLastBackupDisplay();
        }

        // Afficher la date de la derni√®re sauvegarde
        function updateLastBackupDisplay() {
            const lastBackupElement = document.getElementById('lastBackupDate');
            if (autoBackupSettings.lastBackup) {
                const date = new Date(autoBackupSettings.lastBackup);
                lastBackupElement.textContent = date.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else {
                lastBackupElement.textContent = 'Aucune';
            }
        }

        // Activer/d√©sactiver la sauvegarde automatique
        function toggleAutoBackup() {
            autoBackupSettings.enabled = document.getElementById('autoBackupEnabled').checked;
            document.getElementById('autoBackupOptions').style.display = autoBackupSettings.enabled ? 'block' : 'none';
            localStorage.setItem('autoBackupSettings', JSON.stringify(autoBackupSettings));
            updateAutoBackupIndicator();
            
            if (autoBackupSettings.enabled) {
                alert('‚úÖ Sauvegarde automatique activ√©e !');
                performAutoBackup(); // Premi√®re sauvegarde imm√©diate
            } else {
                alert('‚ö†Ô∏è Sauvegarde automatique d√©sactiv√©e');
            }
        }

        // Mettre √† jour la fr√©quence de sauvegarde
        function updateBackupFrequency() {
            autoBackupSettings.frequency = document.getElementById('backupFrequency').value;
            localStorage.setItem('autoBackupSettings', JSON.stringify(autoBackupSettings));
            
            const frequencies = {
                daily: 'quotidienne',
                weekly: 'hebdomadaire',
                monthly: 'mensuelle'
            };
            alert(`‚úÖ Fr√©quence mise √† jour : ${frequencies[autoBackupSettings.frequency]}`);
        }

        // V√©rifier si une sauvegarde automatique est n√©cessaire
        function checkAutoBackup() {
            if (!autoBackupSettings.enabled) return;

            const now = new Date();
            const lastBackup = autoBackupSettings.lastBackup ? new Date(autoBackupSettings.lastBackup) : null;

            if (!lastBackup) {
                // Premi√®re sauvegarde
                performAutoBackup();
                return;
            }

            const daysSinceBackup = Math.floor((now - lastBackup) / (1000 * 60 * 60 * 24));

            let shouldBackup = false;
            switch (autoBackupSettings.frequency) {
                case 'daily':
                    shouldBackup = daysSinceBackup >= 1;
                    break;
                case 'weekly':
                    shouldBackup = daysSinceBackup >= 7;
                    break;
                case 'monthly':
                    shouldBackup = daysSinceBackup >= 30;
                    break;
            }

            if (shouldBackup) {
                performAutoBackup();
            }
        }

        // Effectuer une sauvegarde automatique
        function performAutoBackup() {
            const data = {
                astreintes: astreintes,
                incidents: incidents,
                recuperationsPrises: recuperationsPrises,
                exportDate: new Date().toISOString(),
                version: '1.0',
                autoBackup: true
            };

            const dataStr = JSON.stringify(data, null, 2);
            
            // Sauvegarder dans localStorage comme backup
            localStorage.setItem('autoBackupData', dataStr);
            
            // Mettre √† jour la date de derni√®re sauvegarde
            autoBackupSettings.lastBackup = new Date().toISOString();
            localStorage.setItem('autoBackupSettings', JSON.stringify(autoBackupSettings));
            
            updateLastBackupDisplay();
            
            console.log('‚úÖ Sauvegarde automatique effectu√©e');
        }

        // Sauvegarde manuelle
        function manualBackup() {
            performAutoBackup();
            
            // √âgalement t√©l√©charger le fichier
            const data = {
                astreintes: astreintes,
                incidents: incidents,
                recuperationsPrises: recuperationsPrises,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `astreintes-soc-backup-${dateStr}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('‚úÖ Sauvegarde manuelle effectu√©e et t√©l√©charg√©e !');
        }

        // Restaurer depuis la sauvegarde automatique
        function restoreFromAutoBackup() {
            const backupData = localStorage.getItem('autoBackupData');
            if (!backupData) {
                alert('‚ö†Ô∏è Aucune sauvegarde automatique trouv√©e');
                return;
            }

            if (!confirm('Voulez-vous restaurer les donn√©es depuis la derni√®re sauvegarde automatique ? Cela √©crasera vos donn√©es actuelles.')) {
                return;
            }

            try {
                const data = JSON.parse(backupData);
                
                astreintes = data.astreintes;
                incidents = data.incidents;
                recuperationsPrises = data.recuperationsPrises;

                localStorage.setItem('astreintes', JSON.stringify(astreintes));
                localStorage.setItem('incidents', JSON.stringify(incidents));
                localStorage.setItem('recuperationsPrises', JSON.stringify(recuperationsPrises));

                updateDashboard();
                updateAstreintesList();
                updateIncidentsList();
                updateRecuperationView();
                updateIncidentAstreinteSelect();

                alert('‚úÖ Donn√©es restaur√©es depuis la sauvegarde automatique !');
            } catch (error) {
                alert('‚ùå Erreur lors de la restauration');
                console.error('Restore error:', error);
            }
        }

        // Exporter un incident en PDF
        function exportIncidentToPDF(incidentId) {
            const incident = incidents.find(i => i.id === incidentId);
            if (!incident) {
                alert('‚ùå Incident non trouv√©');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const astreinte = astreintes.find(a => a.id === incident.astreinteId);

            // Titre du document
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('RAPPORT D\'INCIDENT SOC', 105, 20, { align: 'center' });

            // Ligne de s√©paration
            doc.setLineWidth(0.5);
            doc.line(20, 25, 190, 25);

            let yPos = 35;

            // Informations g√©n√©rales
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('INFORMATIONS GENERALES', 20, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');

            // Analyste
            doc.setFont(undefined, 'bold');
            doc.text('Analyste :', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(incident.analyste || 'Non renseign√©', 60, yPos);
            yPos += 7;

            // Ticket GLPI
            if (incident.ticketGLPI) {
                doc.setFont(undefined, 'bold');
                doc.text('Ticket GLPI :', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(42, 82, 152); // Couleur bleue pour le lien
                doc.text(`#${incident.ticketGLPI}`, 60, yPos);
                doc.setTextColor(0, 0, 0); // Retour au noir
                yPos += 7;
            }

            // Date incident
            doc.setFont(undefined, 'bold');
            doc.text('Date incident :', 20, yPos);
            doc.setFont(undefined, 'normal');
            const dateIncident = incident.date ? new Date(incident.date).toLocaleDateString('fr-FR', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            }) : 'Non renseign√©';
            doc.text(dateIncident, 60, yPos);
            yPos += 7;

            // Horaires
            doc.setFont(undefined, 'bold');
            doc.text('Horaires :', 20, yPos);
            doc.setFont(undefined, 'normal');
            const horaires = `${incident.heureDebut || '-'} ${incident.heureFin ? '-> ' + incident.heureFin : ''}`;
            doc.text(horaires, 60, yPos);
            yPos += 7;

            // Temps pass√©
            if (incident.heures > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('Temps passe :', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(`${incident.heures} heure${incident.heures > 1 ? 's' : ''} (avec majoration 30%)`, 60, yPos);
                yPos += 7;
            }

            // S√©v√©rit√©
            const severityLabels = {
                critical: 'Critique',
                high: 'Haute',
                medium: 'Moyenne',
                low: 'Basse',
                'false-positive': 'Faux-positif'
            };
            doc.setFont(undefined, 'bold');
            doc.text('Severite :', 20, yPos);
            doc.setFont(undefined, 'normal');
            doc.text(severityLabels[incident.severity] || incident.severity, 60, yPos);
            yPos += 7;

            // Astreinte associ√©e
            if (astreinte) {
                doc.setFont(undefined, 'bold');
                doc.text('Astreinte :', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(astreinte.nom, 60, yPos);
                yPos += 10;
            } else {
                yPos += 3;
            }

            // Titre de l'incident
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('INCIDENT', 20, yPos);
            yPos += 8;

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Titre :', 20, yPos);
            yPos += 6;
            doc.setFont(undefined, 'normal');
            const titleLines = doc.splitTextToSize(incident.title, 170);
            doc.text(titleLines, 20, yPos);
            yPos += titleLines.length * 5 + 5;

            // Description et op√©rations
            if (incident.description) {
                doc.setFont(undefined, 'bold');
                doc.text('Description et operations menees :', 20, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                const descLines = doc.splitTextToSize(incident.description, 170);
                doc.text(descLines, 20, yPos);
                yPos += descLines.length * 5 + 5;
            }

            // V√©rifier si on doit ajouter une nouvelle page
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }

            // Retex / Probl√®mes
            if (incident.retex) {
                doc.setFont(undefined, 'bold');
                doc.text('Problemes rencontres / Retex :', 20, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
                const retexLines = doc.splitTextToSize(incident.retex, 170);
                doc.text(retexLines, 20, yPos);
                yPos += retexLines.length * 5 + 5;
            }

            // V√©rifier si on doit ajouter une nouvelle page
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }

            // Communications
            if (incident.communications) {
                let commList = [];
                if (incident.communications.cadreAstreinte) commList.push('Cadre d\'astreinte');
                if (incident.communications.dsi) commList.push('DSI');
                if (incident.communications.rssi) commList.push('RSSI');
                if (incident.communications.anssi) commList.push('ANSSI');
                if (incident.communications.shfds) commList.push('SHFDS');
                if (incident.communications.socRie) commList.push('SOC RIE');
                if (incident.communications.soc) commList.push('SOC');
                if (incident.communications.renater) commList.push('RENATER');

                if (commList.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('COMMUNICATIONS', 20, yPos);
                    yPos += 8;

                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    commList.forEach(comm => {
                        doc.text('- ' + comm, 25, yPos);
                        yPos += 6;
                    });
                }
            }

            // Pied de page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                doc.text(`Page ${i} sur ${pageCount}`, 105, 290, { align: 'center' });
                doc.text(`Genere le ${new Date().toLocaleDateString('fr-FR')} a ${new Date().toLocaleTimeString('fr-FR')}`, 105, 285, { align: 'center' });
            }

            // T√©l√©charger le PDF
            const fileName = `incident-${incident.analyste ? incident.analyste.replace(/\s+/g, '_') : 'inconnu'}-${incident.date || new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);

            alert('‚úÖ PDF g√©n√©r√© avec succ√®s !');
        }
    </script>
</body>
</html>
